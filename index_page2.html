<!DOCTYPE html>
<html>

<style>
body {
  font-family: Arial;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

.container {
  display: grid;
  grid-template-columns: 1fr; /*1 row type shi */
  gap: 15px;
  width: 750px;
}


button {
  padding: 18px;
  font-size: 18px;
  width: 100%;
}


.full {
  background: #ccc;
}
</style>
</head>
    <title>Selection page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

<body style="background-color:lightgreen">

<form id="sendForm" action="https://script.google.com/macros/s/AKfycbzdyWIQ6bgnUsGF8KOUZPDKs3knzBCUDROeo3TB24DP-P1LBOLFapC8QF6vqjs7-_ZZ/exec" 
   method="POST" 
   style="display:none;">
  <input name="name">
  <input name="sur">
  <input name="nick">
  <input name="id">
  <input name="clazz">
  <input name="classNum">
  <input name="instrument">
  <input name="choice">
</form>

<div class="container">
  <button onclick="choose('Welfare Division')" id="Welfare Division"></button>
  <button onclick="choose('Equipment & Instrument Division')" id="Equipment & Instrument Division"></button>
  <button onclick="choose('Public Relation')" id="Public Relation"></button>
  <button onclick="choose('Human Resources')" id="Human Resources"></button>
</div>






<script>

const EXEC_URL = "https://script.google.com/macros/s/AKfycbzdyWIQ6bgnUsGF8KOUZPDKs3knzBCUDROeo3TB24DP-P1LBOLFapC8QF6vqjs7-_ZZ/exec";
const OPTIONS = [
  "Welfare Division",
  "Equipment & Instrument Division",
  "Public Relation",
  "Human Resources"
];

// per-option max
const MAX_COUNTS = {
  "Welfare Division": 9,
  "Equipment & Instrument Division": 8,
  "Public Relation": 3,
  "Human Resources": 10
};


// ❌ ถ้าเคยเลือกแล้ว → ไปหน้า 3 ทันที
/*if (localStorage.getItem("submitted") === "yes") {
  location.href = "index_page3.html";
}*/



function render() {
  fetch(EXEC_URL + "?action=getCounts")
    .then(res => res.json())
    .then(counts => {
      OPTIONS.forEach(opt => {
        const used = Number(counts[opt] || 0);
        const max = MAX_COUNTS[opt];           // use per-option max
        const left = max - used;
        const btn = document.getElementById(opt);

        if (left <= 0) {
          btn.textContent = opt + " (FULL)";
          btn.disabled = true;
          btn.classList.add("full");
        } else {
          btn.textContent = opt + ` (${left} left)`;
          btn.disabled = false;
          btn.classList.remove("full");
        }
      });
    });
}

function choose(opt) {
  const user = JSON.parse(localStorage.getItem("userInfo"));

  const form = document.getElementById("sendForm");
  form.name.value = user.name;
  form.sur.value = user.sur;
  form.nick.value = user.nick;
  form.id.value = user.id;
  form.clazz.value = user.clazz;
  form.classNum.value = user.classNum;
  form.instrument.value = user.instrument;
  form.choice.value = opt;

  form.submit(); // this sends data without CORS issues
}




function HARD_RESET() {
  if (!confirm("RESET ALL COUNTS AND USERS?")) return;

  // 1️⃣ reset server
  fetch(EXEC_URL + "?action=reset")
    .then(res => res.text())
    .then(msg => {
      console.log(msg);

      // 2️⃣ reset local submitted + counters แต่เก็บ userInfo
      localStorage.removeItem("submitted");
      OPTIONS.forEach(o => localStorage.removeItem(o));

      alert("RESET COMPLETE");

       // กลับหน้าแรก
    })
    .catch(err => {
      console.error(err);
      alert("RESET FAILED");
    });
}







function sendToGoogleSheet(choice) {
  const user = JSON.parse(localStorage.getItem("userInfo"));

  fetch(EXEC_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      name: user.name,
      sur: user.sur,
      nick: user.nick,
      id: user.id,
      clazz: user.clazz,
      classNum: user.classNum,
      instrument: user.instrument,
      choice: choice
    })
  });

  fetch(EXEC_URL + "?action=choose&option=" + encodeURIComponent(choice))
  .then(res => res.text())
  .then(res => {
    if (res === "OK") {
      localStorage.setItem("submitted", "yes");
      localStorage.setItem("chosen", choice);
      location.href = "index_page3.html";
    } else {
      alert("This option is FULL");
    }
  });

}




render();
</script>


</body>
</html>
